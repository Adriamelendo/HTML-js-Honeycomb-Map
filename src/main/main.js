/*       ___ _       _           _                   _       _     _           
 *      / _ \ | ___ | |__   __ _| | __   ____ _ _ __(_) __ _| |__ | | ___  ___ 
 *     / /_\/ |/ _ \| '_ \ / _` | | \ \ / / _` | '__| |/ _` | '_ \| |/ _ \/ __|
 *    / /_\\| | (_) | |_) | (_| | |  \ V / (_| | |  | | (_| | |_) | |  __/\__ \
 *    \____/|_|\___/|_.__/ \__,_|_|   \_/ \__,_|_|  |_|\__,_|_.__/|_|\___||___/                                                                             
 */

const config = ({
    lat: 28.261146,
    lng: -16.595508,
    zoom: 10,
    fillOpacity: 0.6,
    colorScale: [
        ['#f0f0f0', '#bdbdbd', '#636363'],
        ['#deebf7', '#9ecae1', '#3182bd'],
        ['#e5f5e0', '#a1d99b', '#31a354'],
        ['#fee6ce', '#fdae6b', '#e6550d'],
        ['#efedf5', '#bcbddc', '#756bb1'],
        ['#fee0d2', '#fc9272', '#de2d26']
    ]
});

//mostrar km 2 de del hexagono

// tama침o m치s peque침o h3Resolution = 10 (es bloque de edificios), quizas 9 por privacidad
// min: 10
// Mundo max: 2
// Espa침a max: 3
// Provincia max: 5
const h3Resolution = 7;
let maxpersonsinhex = 1;
let nhits = 0;
let contornos = {};
let areas = {};

let hexagons = [];
let barcelona = '';
let info = '';
/*       _                  ___                 _   _                 
 *      /_\  _   ___  __   / __\   _ _ __   ___| |_(_) ___  _ __  ___ 
 *     //_\\| | | \ \/ /  / _\| | | | '_ \ / __| __| |/ _ \| '_ \/ __|
 *    /  _  \ |_| |>  <  / /  | |_| | | | | (__| |_| | (_) | | | \__ \
 *    \_/ \_/\__,_/_/\_\ \/    \__,_|_| |_|\___|\__|_|\___/|_| |_|___/
 */
function getRandomIntInHex() {
    const maxpersonsinhex10 = 2;
    maxpersonsinhex = maxpersonsinhex10 * Math.pow(7, 10 - h3Resolution);
    return getRandomInt(0, maxpersonsinhex);
}

function getRandomInt(min, max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
}

/*       __                 _       ___                 _   _                 
 *      /__\_   _____ _ __ | |_    / __\   _ _ __   ___| |_(_) ___  _ __  ___ 
 *     /_\ \ \ / / _ \ '_ \| __|  / _\| | | | '_ \ / __| __| |/ _ \| '_ \/ __|
 *    //__  \ V /  __/ | | | |_  / /  | |_| | | | | (__| |_| | (_) | | | \__ \
 *    \__/   \_/ \___|_| |_|\__| \/    \__,_|_| |_|\___|\__|_|\___/|_| |_|___/
 */
function highlightFeature(e) {
    var layer = e.target;

    layer.setStyle({
        fillColor: '#666',
        fillOpacity: 1
    });

    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
    }
    info.update(layer.feature.properties);
}
function resetHighlight(e) {
    barcelona.resetStyle(e.target);
    info.update();
}
// function zoomToFeature(e) {
//    map.fitBounds(e.target.getBounds());
//}
function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        // click: zoomToFeature
    });
}

function mouseover(lng, lat) {
    const centerHex = h3.geoToH3(lat, lng, h3Resolution);
    const info = document.getElementById("sidebar3");
    info.innerHTML = centerHex;
}

/*                  _           ___                          _ 
 *      /\/\   __ _(_)_ __     / _ \___ _ __   ___ _ __ __ _| |
 *     /    \ / _` | | '_ \   / /_\/ _ \ '_ \ / _ \ '__/ _` | |
 *    / /\/\ \ (_| | | | | | / /_\\  __/ | | |  __/ | | (_| | |
 *    \/    \/\__,_|_|_| |_| \____/\___|_| |_|\___|_|  \__,_|_|
 */

// const url = 'https://data.opendatasoft.com/api/records/1.0/search/?dataset=espana-municipios%40public&facet=communidad_autonoma&facet=provincia&facet=municipio&refine.provincia=Barcelona'
// const url = "https://data.opendatasoft.com/api/records/1.0/search/?dataset=espana-municipios%40public&rows=313&facet=communidad_autonoma&facet=provincia&facet=municipio&geofilter.distance=28.261146%2C-16.595508%2C20000"
// const url = './data/listaMunicipios10barcelona.json'
// const url = './data/listaMunicipios.json'

// const url = 'https://data.opendatasoft.com/api/records/1.0/search/?dataset=espana-municipios%40public&rows=500&facet=communidad_autonoma&facet=provincia&facet=municipio&geofilter.distance=28.261146%2C+-16.595508%2C+100000'
// islas canarias
// const url = 'https://data.opendatasoft.com/api/records/1.0/search/?dataset=espana-municipios%40public&rows=100&facet=communidad_autonoma&facet=provincia&facet=municipio&refine.communidad_autonoma=Islas+Canarias';
// tenerife
// const url = 'https://data.opendatasoft.com/api/records/1.0/search/?dataset=espana-municipios%40public&rows=53&facet=communidad_autonoma&facet=provincia&facet=municipio&refine.communidad_autonoma=Islas+Canarias&refine.provincia=Santa+Cruz+de+Tenerife'
// const url = './data/tenerife.json'

// const url = './data/tenerife20km.json'

// const url = "https://data.opendatasoft.com/api/records/1.0/search/?dataset=espana-municipios%40public&rows=23&facet=communidad_autonoma&facet=provincia&facet=municipio&geofilter.distance=28.320796%2C-16.498489%2C20000"
const url = './data/fail.json'

d3.json(url).then(function (data) {
    calculate(data);
});

function styleasy(feature) {
    // we can use feature.properties.colorscale
    return {
        stroke: true,
        fill: false,
        weight: 2,
        opacity: 1,
        color: '#ff0000'
    };
}

function calculate(listaMunicipios) {
    nhits = listaMunicipios.nhits;

    let start = 0;
    let end = nhits;
    //test
    start = 0;
    end = 2;
    // end test

    let municipios = [];
    for (let d = 0; d < nhits; d++) {
        municipios.push({
            type: 'Feature',
            recordid: listaMunicipios.records[d].recordid,
            // recordid: listaMunicipios.records[d].fields.codigo_postal,
            colorscale: (parseInt(listaMunicipios.records[d].recordid, 16) % 5 + 1),
            municipio: listaMunicipios.records[d].fields.municipio,
            provincia: listaMunicipios.records[d].fields.provincia,
            communidad_autonoma: listaMunicipios.records[d].fields.communidad_autonoma,
            pais: listaMunicipios.records[d].fields.pais,
            geo_point_2d: listaMunicipios.records[d].fields.geo_point_2d,
            geometry: listaMunicipios.records[d].fields.geo_shape,
            dist: (listaMunicipios.records[d].fields.dist) ? listaMunicipios.records[d].fields.dist : 0
        });
    }

    // contornos reales
    for (let d = start; d < end; d++) {
        L.geoJson(municipios[d], { style: styleasy }).addTo(map);
        console.log(municipios[d]);
    }

    let listhexagons = [];
    
     /*    for (let d = 0; d < nhits; d++) {
            const templist = geojson2h3.featureToH3Set(municipios[d], h3Resolution);
            const unique = [...new Set(templist)];
            listhexagons.push(unique);
        }
    
 */

    // if (listhexagons[d] == undefined) { ... }

    //1 funciona, 0 falla
    if (1) {
        // este si que va 
        console.log('first');
        let d = 0;
        listhexagons[0] = geojson2h3.featureToH3Set({
            type: 'Feature',
            geometry: {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            -16.465055465698185,
                            28.369049072265625
                        ],
                        [
                            -16.45879554748535,
                            28.378807067871094
                        ],
                        [
                            -16.44406509399414,
                            28.387451171875057
                        ],
                        [
                            -16.44787216186523,
                            28.37966537475586
                        ],
                        [
                            -16.418262481689396,
                            28.358766555786243
                        ],
                        [
                            -16.40911293029785,
                            28.347583770751953
                        ],
                        [
                            -16.385181427001896,
                            28.33437728881847
                        ],
                        [
                            -16.366798400878793,
                            28.335670471191406
                        ],
                        [
                            -16.38293266296381,
                            28.32360458374023
                        ],
                        [
                            -16.409254074096623,
                            28.33025550842291
                        ],
                        [
                            -16.437534332275334,
                            28.328931808471623
                        ],
                        [
                            -16.454076766967717,
                            28.33304786682129
                        ],
                        [
                            -16.48571014404291,
                            28.33262252807623
                        ],
                        [
                            -16.48360061645502,
                            28.344596862793082
                        ],
                        [
                            -16.468414306640625,
                            28.352144241333008
                        ],
                        [
                            -16.465055465698185,
                            28.369049072265625
                        ]
                    ]
                ]
            }
        }, h3Resolution);
        contornos[municipios[d].recordid] = geojson2h3.h3SetToFeature(
            listhexagons[d]
        );
        console.log('second');
        d = 1;
        listhexagons[1] = geojson2h3.featureToH3Set({
            type: 'Feature',
            geometry: {
                "type": "Polygon",
                "coordinates": [
                    [
                        [
                            -16.36458206176752,
                            28.33587646484375
                        ],
                        [
                            -16.36458206176752,
                            28.335695266723576
                        ],
                        [
                            -16.364305496215817,
                            28.335695266723576
                        ],
                        [
                            -16.364305496215817,
                            28.335416793823185
                        ],
                        [
                            -16.36402702331543,
                            28.335416793823185
                        ],
                        [
                            -16.36402702331543,
                            28.334861755371204
                        ],
                        [
                            -16.363752365112305,
                            28.334861755371204
                        ],
                        [
                            -16.363752365112305,
                            28.334304809570426
                        ],
                        [
                            -16.36347007751459,
                            28.334304809570426
                        ],
                        [
                            -16.36347007751459,
                            28.333751678466854
                        ],
                        [
                            -16.362916946411076,
                            28.333751678466854
                        ],
                        [
                            -16.362916946411076,
                            28.332916259765682
                        ],
                        [
                            -16.362638473510682,
                            28.332916259765682
                        ],
                        [
                            -16.362638473510682,
                            28.331806182861328
                        ],
                        [
                            -16.362916946411076,
                            28.331806182861328
                        ],
                        [
                            -16.362916946411076,
                            28.330137252807617
                        ],
                        [
                            -16.36319351196289,
                            28.330137252807617
                        ],
                        [
                            -16.363195419311467,
                            28.32958412170421
                        ],
                        [
                            -16.36347007751459,
                            28.32958412170421
                        ],
                        [
                            -16.36347007751459,
                            28.327457427978572
                        ],
                        [
                            -16.36347007751459,
                            28.326250076294
                        ],
                        [
                            -16.363195419311467,
                            28.326250076294
                        ],
                        [
                            -16.36319351196289,
                            28.325416564941403
                        ],
                        [
                            -16.362916946411076,
                            28.325416564941403
                        ],
                        [
                            -16.362916946411076,
                            28.325138092041072
                        ],
                        [
                            -16.362638473510682,
                            28.325138092041072
                        ],
                        [
                            -16.362638473510682,
                            28.32458114624029
                        ],
                        [
                            -16.362361907958984,
                            28.32458114624029
                        ],
                        [
                            -16.362361907958984,
                            28.32402801513672
                        ],
                        [
                            -16.362083435058594,
                            28.32402801513672
                        ],
                        [
                            -16.362083435058594,
                            28.323471069335938
                        ],
                        [
                            -16.361858367919922,
                            28.323471069335938
                        ],
                        [
                            -16.3618488311767,
                            28.323337554931754
                        ],
                        [
                            -16.361804962158143,
                            28.32263946533214
                        ],
                        [
                            -16.361528396606445,
                            28.32263946533214
                        ],
                        [
                            -16.361528396606445,
                            28.32236289978033
                        ],
                        [
                            -16.361408233642578,
                            28.32236289978033
                        ],
                        [
                            -16.361249923706055,
                            28.32236289978033
                        ],
                        [
                            -16.361249923706055,
                            28.322082519531364
                        ],
                        [
                            -16.360971450805664,
                            28.322082519531364
                        ],
                        [
                            -16.360971450805664,
                            28.32180595397955
                        ],
                        [
                            -16.360694885253793,
                            28.32180595397955
                        ],
                        [
                            -16.360694885253793,
                            28.3212509155274
                        ],
                        [
                            -16.360416412353512,
                            28.3212509155274
                        ],
                        [
                            -16.360416412353512,
                            28.320972442627006
                        ],
                        [
                            -16.3601398468017,
                            28.320972442627006
                        ],
                        [
                            -16.360137939453125,
                            28.320140838623047
                        ],
                        [
                            -16.35986137390131,
                            28.320140838623047
                        ],
                        [
                            -16.35986137390131,
                            28.31986045837408
                        ],
                        [
                            -16.360137939453125,
                            28.31986045837408
                        ],
                        [
                            -16.360137939453125,
                            28.31922721862793
                        ],
                        [
                            -16.360137939453125,
                            28.317636489868164
                        ],
                        [
                            -16.35986137390131,
                            28.317636489868164
                        ],
                        [
                            -16.35986137390131,
                            28.316190719604492
                        ],
                        [
                            -16.35986137390131,
                            28.31569671630865
                        ],
                        [
                            -16.360137939453125,
                            28.31569671630865
                        ],
                        [
                            -16.360137939453125,
                            28.314582824707085
                        ],
                        [
                            -16.360013961791992,
                            28.314582824707085
                        ],
                        [
                            -16.35986137390131,
                            28.314582824707085
                        ],
                        [
                            -16.35986137390131,
                            28.31291580200195
                        ],
                        [
                            -16.360137939453125,
                            28.31291580200195
                        ],
                        [
                            -16.3601398468017,
                            28.31208229064941
                        ],
                        [
                            -16.360252380371094,
                            28.31208229064941
                        ],
                        [
                            -16.360416412353512,
                            28.31208229064941
                        ],
                        [
                            -16.360416412353512,
                            28.31125068664562
                        ],
                        [
                            -16.360694885253793,
                            28.31125068664562
                        ],
                        [
                            -16.360694885253793,
                            28.31069374084484
                        ],
                        [
                            -16.360971450805664,
                            28.31069374084484
                        ],
                        [
                            -16.360971450805664,
                            28.3098602294923
                        ],
                        [
                            -16.361249923706055,
                            28.3098602294923
                        ],
                        [
                            -16.361249923706055,
                            28.309305191040092
                        ],
                        [
                            -16.361528396606445,
                            28.309305191040092
                        ],
                        [
                            -16.361528396606445,
                            28.309028625488338
                        ],
                        [
                            -16.361249923706055,
                            28.309028625488338
                        ],
                        [
                            -16.361249923706055,
                            28.30791664123535
                        ],
                        [
                            -16.361528396606445,
                            28.30791664123535
                        ],
                        [
                            -16.361528396606445,
                            28.306528091430664
                        ],
                        [
                            -16.361804962158143,
                            28.306528091430664
                        ],
                        [
                            -16.361804962158143,
                            28.305416107177678
                        ],
                        [
                            -16.362083435058594,
                            28.305416107177678
                        ],
                        [
                            -16.362083435058594,
                            28.304861068725696
                        ],
                        [
                            -16.362361907958984,
                            28.304861068725696
                        ],
                        [
                            -16.362361907958984,
                            28.30458259582531
                        ],
                        [
                            -16.362638473510682,
                            28.30458259582531
                        ],
                        [
                            -16.362638473510682,
                            28.304029464721737
                        ],
                        [
                            -16.362916946411076,
                            28.304029464721737
                        ],
                        [
                            -16.362916946411076,
                            28.303747177123967
                        ],
                        [
                            -16.36319351196289,
                            28.303747177123967
                        ],
                        [
                            -16.363195419311467,
                            28.303472518920955
                        ],
                        [
                            -16.36347007751459,
                            28.303472518920955
                        ],
                        [
                            -16.36347007751459,
                            28.30319595336914
                        ],
                        [
                            -16.363752365112305,
                            28.30319595336914
                        ],
                        [
                            -16.363752365112305,
                            28.302915573120174
                        ],
                        [
                            -16.36402702331543,
                            28.302915573120174
                        ],
                        [
                            -16.36402702331543,
                            28.302637100219783
                        ],
                        [
                            -16.364305496215817,
                            28.302637100219783
                        ],
                        [
                            -16.364305496215817,
                            28.302085876464787
                        ],
                        [
                            -16.36458206176752,
                            28.302085876464787
                        ],
                        [
                            -16.36458206176752,
                            28.30180740356445
                        ],
                        [
                            -16.36486053466791,
                            28.30180740356445
                        ],
                        [
                            -16.36486053466791,
                            28.301525115966854
                        ],
                        [
                            -16.365140914916992,
                            28.301525115966854
                        ],
                        [
                            -16.365140914916992,
                            28.301250457763672
                        ],
                        [
                            -16.365692138671875,
                            28.301250457763672
                        ],
                        [
                            -16.365692138671875,
                            28.30097198486328
                        ],
                        [
                            -16.366527557373047,
                            28.30097198486328
                        ],
                        [
                            -16.366527557373047,
                            28.300693511962887
                        ],
                        [
                            -16.367639541625977,
                            28.300693511962887
                        ],
                        [
                            -16.367639541625977,
                            28.300416946411076
                        ],
                        [
                            -16.368194580078068,
                            28.300416946411076
                        ],
                        [
                            -16.368194580078068,
                            28.300138473510742
                        ],
                        [
                            -16.36874961853016,
                            28.300138473510742
                        ],
                        [
                            -16.36874961853016,
                            28.299861907959098
                        ],
                        [
                            -16.369028091430607,
                            28.299861907959098
                        ],
                        [
                            -16.369028091430607,
                            28.299583435058707
                        ],
                        [
                            -16.369583129882812,
                            28.299583435058707
                        ],
                        [
                            -16.369583129882812,
                            28.29930305480957
                        ],
                        [
                            -16.37013816833496,
                            28.29930305480957
                        ],
                        [
                            -16.37013816833496,
                            28.29902839660656
                        ],
                        [
                            -16.370416641235348,
                            28.29902839660656
                        ],
                        [
                            -16.370416641235348,
                            28.298471450805774
                        ],
                        [
                            -16.370695114135742,
                            28.298471450805774
                        ],
                        [
                            -16.370695114135742,
                            28.298194885253963
                        ],
                        [
                            -16.370971679687443,
                            28.298194885253963
                        ],
                        [
                            -16.370971679687443,
                            28.297639846801815
                        ],
                        [
                            -16.371250152587834,
                            28.29763793945324
                        ],
                        [
                            -16.371250152587834,
                            28.297082901001033
                        ],
                        [
                            -16.371528625488224,
                            28.297082901001033
                        ],
                        [
                            -16.371528625488224,
                            28.29680633544922
                        ],
                        [
                            -16.371805191039925,
                            28.29680633544922
                        ],
                        [
                            -16.371805191039925,
                            28.29624938964849
                        ],
                        [
                            -16.372083663940373,
                            28.29624938964849
                        ],
                        [
                            -16.372083663940373,
                            28.29569435119629
                        ],
                        [
                            -16.372360229492188,
                            28.29569435119629
                        ],
                        [
                            -16.372360229492188,
                            28.2954158782959
                        ],
                        [
                            -16.372638702392578,
                            28.2954158782959
                        ],
                        [
                            -16.372638702392578,
                            28.29513931274414
                        ],
                        [
                            -16.373472213745117,
                            28.29513931274414
                        ],
                        [
                            -16.373472213745117,
                            28.29486083984375
                        ],
                        [
                            -16.373750686645508,
                            28.29486083984375
                        ],
                        [
                            -16.373750686645508,
                            28.294584274292106
                        ],
                        [
                            -16.3743057250976,
                            28.294584274292106
                        ],
                        [
                            -16.3743057250976,
                            28.294305801391545
                        ],
                        [
                            -16.37513923645008,
                            28.294305801391545
                        ],
                        [
                            -16.37513923645008,
                            28.294027328491154
                        ],
                        [
                            -16.375415802001953,
                            28.294027328491154
                        ],
                        [
                            -16.375415802001953,
                            28.293750762939567
                        ],
                        [
                            -16.375694274902344,
                            28.293750762939567
                        ],
                        [
                            -16.375694274902344,
                            28.293472290039176
                        ],
                        [
                            -16.376249313354435,
                            28.293472290039176
                        ],
                        [
                            -16.376249313354435,
                            28.293193817138782
                        ],
                        [
                            -16.376806259155273,
                            28.293193817138782
                        ],
                        [
                            -16.376806259155273,
                            28.292917251587028
                        ],
                        [
                            -16.377082824706974,
                            28.292917251587028
                        ],
                        [
                            -16.377082824706974,
                            28.29264068603521
                        ],
                        [
                            -16.37735939025879,
                            28.29264068603521
                        ],
                        [
                            -16.37735939025879,
                            28.292358398437443
                        ],
                        [
                            -16.377641677856445,
                            28.292358398437443
                        ],
                        [
                            -16.377641677856445,
                            28.29180526733404
                        ],
                        [
                            -16.37791633605957,
                            28.29180526733404
                        ],
                        [
                            -16.37791633605957,
                            28.291528701782283
                        ],
                        [
                            -16.378194808959847,
                            28.291528701782283
                        ],
                        [
                            -16.378194808959847,
                            28.290971755981502
                        ],
                        [
                            -16.37847137451172,
                            28.290971755981502
                        ],
                        [
                            -16.37847137451172,
                            28.290695190429688
                        ],
                        [
                            -16.378751754760685,
                            28.290695190429688
                        ],
                        [
                            -16.378751754760685,
                            28.29041862487793
                        ],
                        [
                            -16.379028320312496,
                            28.29041862487793
                        ],
                        [
                            -16.379028320312496,
                            28.289304733276367
                        ],
                        [
                            -16.3793048858642,
                            28.289304733276367
                        ],
                        [
                            -16.3793048858642,
                            28.28874969482422
                        ],
                        [
                            -16.379581451416016,
                            28.28874969482422
                        ],
                        [
                            -16.379581451416016,
                            28.288473129272575
                        ],
                        [
                            -16.38013839721674,
                            28.288473129272575
                        ],
                        [
                            -16.38013839721674,
                            28.288196563720813
                        ],
                        [
                            -16.38069534301752,
                            28.288196563720813
                        ],
                        [
                            -16.38069534301752,
                            28.287914276123047
                        ],
                        [
                            -16.380973815917912,
                            28.287914276123047
                        ],
                        [
                            -16.380973815917912,
                            28.287639617920036
                        ],
                        [
                            -16.381526947021484,
                            28.287639617920036
                        ],
                        [
                            -16.381526947021484,
                            28.287361145019645
                        ],
                        [
                            -16.381805419921875,
                            28.287361145019645
                        ],
                        [
                            -16.381805419921875,
                            28.28708267211925
                        ],
                        [
                            -16.382360458373967,
                            28.28708267211925
                        ],
                        [
                            -16.382360458373967,
                            28.286804199218864
                        ],
                        [
                            -16.382638931274354,
                            28.286804199218864
                        ],
                        [
                            -16.382638931274354,
                            28.28624916076671
                        ],
                        [
                            -16.382917404174805,
                            28.28624916076671
                        ],
                        [
                            -16.382917404174805,
                            28.2859725952149
                        ],
                        [
                            -16.383195877075195,
                            28.2859725952149
                        ],
                        [
                            -16.383195877075195,
                            28.28486061096197
                        ],
                        [
                            -16.383472442626893,
                            28.28486061096197
                        ],
                        [
                            -16.383472442626893,
                            28.284582138061577
                        ],
                        [
                            -16.383750915527287,
                            28.284582138061577
                        ],
                        [
                            -16.383750915527287,
                            28.284305572509766
                        ],
                        [
                            -16.3840274810791,
                            28.284305572509766
                        ],
                        [
                            -16.3840274810791,
                            28.282634735107475
                        ],
                        [
                            -16.3840274810791,
                            28.282360076904297
                        ],
                        [
                            -16.383750915527287,
                            28.282360076904297
                        ],
                        [
                            -16.383750915527287,
                            28.28125190734869
                        ],
                        [
                            -16.3840274810791,
                            28.28125190734869
                        ],
                        [
                            -16.3840274810791,
                            28.27847290039062
                        ],
                        [
                            -16.383472442626893,
                            28.27847290039062
                        ],
                        [
                            -16.383472442626893,
                            28.278194427490234
                        ],
                        [
                            -16.383195877075195,
                            28.278194427490234
                        ],
                        [
                            -16.383195877075195,
                            28.277917861938473
                        ],
                        [
                            -16.382638931274354,
                            28.277917861938473
                        ],
                        [
                            -16.382638931274354,
                            28.277639389038086
                        ],
                        [
                            -16.382360458373967,
                            28.277639389038086
                        ],
                        [
                            -16.382360458373967,
                            28.277360916137695
                        ],
                        [
                            -16.382638931274354,
                            28.277360916137695
                        ],
                        [
                            -16.382638931274354,
                            28.27652549743652
                        ],
                        [
                            -16.382917404174805,
                            28.27652549743652
                        ],
                        [
                            -16.382917404174805,
                            28.276250839233512
                        ],
                        [
                            -16.383195877075195,
                            28.276250839233512
                        ],
                        [
                            -16.383195877075195,
                            28.27597236633312
                        ],
                        [
                            -16.383472442626893,
                            28.27597236633312
                        ],
                        [
                            -16.383472442626893,
                            28.274860382080192
                        ],
                        [
                            -16.383750915527287,
                            28.274860382080192
                        ],
                        [
                            -16.383750915527287,
                            28.274585723876953
                        ],
                        [
                            -16.383472442626893,
                            28.274585723876953
                        ],
                        [
                            -16.383472442626893,
                            28.27236175537109
                        ],
                        [
                            -16.383750915527287,
                            28.27236175537109
                        ],
                        [
                            -16.383750915527287,
                            28.272083282470703
                        ],
                        [
                            -16.3840274810791,
                            28.272083282470703
                        ],
                        [
                            -16.3840274810791,
                            28.271804809570312
                        ],
                        [
                            -16.38458251953125,
                            28.271804809570312
                        ],
                        [
                            -16.38458251953125,
                            28.27152824401855
                        ],
                        [
                            -16.38486099243164,
                            28.27152824401855
                        ],
                        [
                            -16.38486099243164,
                            28.271249771118164
                        ],
                        [
                            -16.385025024414062,
                            28.271249771118164
                        ],
                        [
                            -16.385139465332028,
                            28.271249771118164
                        ],
                        [
                            -16.385139465332028,
                            28.270971298217773
                        ],
                        [
                            -16.385417938232422,
                            28.270971298217773
                        ],
                        [
                            -16.385417938232422,
                            28.27069473266613
                        ],
                        [
                            -16.385694503784123,
                            28.27069473266613
                        ],
                        [
                            -16.385694503784123,
                            28.270416259765568
                        ],
                        [
                            -16.385972976684567,
                            28.270416259765568
                        ],
                        [
                            -16.385972976684567,
                            28.27013969421398
                        ],
                        [
                            -16.386249542236214,
                            28.27013969421398
                        ],
                        [
                            -16.386249542236214,
                            28.26986122131359
                        ],
                        [
                            -16.386526107788086,
                            28.26986122131359
                        ],
                        [
                            -16.386526107788086,
                            28.269306182861385
                        ],
                        [
                            -16.386806488037053,
                            28.269306182861385
                        ],
                        [
                            -16.386806488037053,
                            28.268472671508846
                        ],
                        [
                            -16.387083053588867,
                            28.268472671508846
                        ],
                        [
                            -16.387083053588867,
                            28.266603469848746
                        ],
                        [
                            -16.387083053588867,
                            28.265417098998963
                        ],
                        [
                            -16.387361526489258,
                            28.265417098998963
                        ],
                        [
                            -16.387361526489258,
                            28.264862060546985
                        ],
                        [
                            -16.387638092041016,
                            28.264862060546985
                        ],
                        [
                            -16.387638092041016,
                            28.264583587646598
                        ],
                        [
                            -16.387916564941406,
                            28.264583587646598
                        ],
                        [
                            -16.387916564941406,
                            28.264305114746207
                        ],
                        [
                            -16.388195037841793,
                            28.264305114746207
                        ],
                        [
                            -16.388195037841793,
                            28.26375007629406
                        ],
                        [
                            -16.388471603393498,
                            28.26375007629406
                        ],
                        [
                            -16.388471603393498,
                            28.26347160339367
                        ],
                        [
                            -16.388748168945312,
                            28.26347160339367
                        ],
                        [
                            -16.388748168945312,
                            28.263196945190487
                        ],
                        [
                            -16.38902854919428,
                            28.263196945190487
                        ],
                        [
                            -16.38902854919428,
                            28.262636184692496
                        ],
                        [
                            -16.38930511474598,
                            28.262636184692496
                        ],
                        [
                            -16.38930511474598,
                            28.262361526489315
                        ],
                        [
                            -16.389583587646428,
                            28.262361526489315
                        ],
                        [
                            -16.389583587646428,
                            28.262083053588924
                        ],
                        [
                            -16.389860153198242,
                            28.262083053588924
                        ],
                        [
                            -16.389860153198242,
                            28.261526107788143
                        ],
                        [
                            -16.390138626098633,
                            28.261526107788143
                        ],
                        [
                            -16.390138626098633,
                            28.261249542236385
                        ],
                        [
                            -16.390417098999023,
                            28.261249542236385
                        ],
                        [
                            -16.390417098999023,
                            28.260974884033143
                        ],
                        [
                            -16.39069366455078,
                            28.260974884033143
                        ],
                        [
                            -16.39069366455078,
                            28.260694503784176
                        ],
                        [
                            -16.390827178954964,
                            28.260694503784176
                        ],
                        [
                            -16.390970230102425,
                            28.260694503784176
                        ],
                        [
                            -16.390970230102425,
                            28.260465621948242
                        ],
                        [
                            -16.39125251770014,
                            28.26041412353521
                        ],
                        [
                            -16.39125251770014,
                            28.260139465332028
                        ],
                        [
                            -16.391527175903263,
                            28.260139465332028
                        ],
                        [
                            -16.391527175903263,
                            28.25986099243164
                        ],
                        [
                            -16.391805648803654,
                            28.25986099243164
                        ],
                        [
                            -16.391805648803654,
                            28.25958251953125
                        ],
                        [
                            -16.392362594604492,
                            28.25958251953125
                        ],
                        [
                            -16.392362594604492,
                            28.25930404663086
                        ],
                        [
                            -16.392639160156133,
                            28.25930404663086
                        ],
                        [
                            -16.392639160156133,
                            28.25902748107904
                        ],
                        [
                            -16.392915725708008,
                            28.25902748107904
                        ],
                        [
                            -16.392917633056584,
                            28.258750915527454
                        ],
                        [
                            -16.39319229125971,
                            28.258750915527454
                        ],
                        [
                            -16.39319229125971,
                            28.258192062377926
                        ],
                        [
                            -16.393474578857365,
                            28.258192062377926
                        ],
                        [
                            -16.393474578857365,
                            28.257917404174915
                        ],
                        [
                            -16.39374923706049,
                            28.257917404174915
                        ],
                        [
                            -16.39374923706049,
                            28.257638931274528
                        ],
                        [
                            -16.394027709960938,
                            28.257638931274528
                        ],
                        [
                            -16.394027709960938,
                            28.256805419921932
                        ],
                        [
                            -16.394306182861328,
                            28.256805419921932
                        ],
                        [
                            -16.394306182861328,
                            28.25625038146978
                        ],
                        [
                            -16.39458465576172,
                            28.25625038146978
                        ],
                        [
                            -16.39458465576172,
                            28.255416870117184
                        ],
                        [
                            -16.39486122131342,
                            28.255416870117184
                        ],
                        [
                            -16.39486122131342,
                            28.255138397216854
                        ],
                        [
                            -16.39513969421381,
                            28.255138397216854
                        ],
                        [
                            -16.39513969421381,
                            28.254304885864258
                        ],
                        [
                            -16.395416259765625,
                            28.254304885864258
                        ],
                        [
                            -16.395416259765625,
                            28.2540283203125
                        ],
                        [
                            -16.3956947326659,
                            28.2540283203125
                        ],
                        [
                            -16.3956947326659,
                            28.25347137451172
                        ],
                        [
                            -16.395971298217773,
                            28.25347137451172
                        ],
                        [
                            -16.395971298217773,
                            28.252574920654407
                        ],
                        [
                            -16.395971298217773,
                            28.252361297607536
                        ],
                        [
                            -16.396106719970703,
                            28.252361297607536
                        ],
                        [
                            -16.396249771118164,
                            28.252361297607536
                        ],
                        [
                            -16.396249771118164,
                            28.252136230468746
                        ],
                        [
                            -16.396249771118164,
                            28.251806259155327
                        ],
                        [
                            -16.396528244018555,
                            28.251806259155327
                        ],
                        [
                            -16.396528244018555,
                            28.251695632934627
                        ],
                        [
                            -16.396528244018555,
                            28.2506942749024
                        ],
                        [
                            -16.396806716918938,
                            28.2506942749024
                        ],
                        [
                            -16.396806716918938,
                            28.250417709350643
                        ],
                        [
                            -16.397083282470703,
                            28.250417709350643
                        ],
                        [
                            -16.397083282470703,
                            28.25013923645025
                        ],
                        [
                            -16.397361755371094,
                            28.25013923645025
                        ],
                        [
                            -16.397361755371094,
                            28.24986076354986
                        ],
                        [
                            -16.397638320922795,
                            28.24986076354986
                        ],
                        [
                            -16.397638320922795,
                            28.249584197998047
                        ],
                        [
                            -16.397916793823185,
                            28.249584197998047
                        ],
                        [
                            -16.397916793823185,
                            28.248472213745114
                        ],
                        [
                            -16.398195266723572,
                            28.248472213745114
                        ],
                        [
                            -16.398195266723572,
                            28.248193740844727
                        ],
                        [
                            -16.39847183227539,
                            28.248193740844727
                        ],
                        [
                            -16.39847183227539,
                            28.247915267944336
                        ],
                        [
                            -16.3989200592041,
                            28.247915267944336
                        ],
                        [
                            -16.399028778076058,
                            28.247915267944336
                        ],
                        [
                            -16.399028778076058,
                            28.247751235962028
                        ],
                        [
                            -16.399028778076058,
                            28.247638702392575
                        ],
                        [
                            -16.39930534362793,
                            28.247638702392575
                        ],
                        [
                            -16.39930534362793,
                            28.247360229492188
                        ],
                        [
                            -16.39986038208002,
                            28.247360229492188
                        ],
                        [
                            -16.39986038208002,
                            28.24708366394054
                        ],
                        [
                            -16.400138854980412,
                            28.24708366394054
                        ],
                        [
                            -16.400138854980412,
                            28.24652862548839
                        ],
                        [
                            -16.40041732788086,
                            28.24652862548839
                        ],
                        [
                            -16.40041732788086,
                            28.246250152588004
                        ],
                        [
                            -16.40069389343256,
                            28.246250152588004
                        ],
                        [
                            -16.40069389343256,
                            28.245693206787223
                        ],
                        [
                            -16.40097236633295,
                            28.245693206787223
                        ],
                        [
                            -16.40097236633295,
                            28.24486160278326
                        ],
                        [
                            -16.401250839233338,
                            28.24486160278326
                        ],
                        [
                            -16.401250839233338,
                            28.244241714477596
                        ],
                        [
                            -16.401250839233338,
                            28.244028091430717
                        ],
                        [
                            -16.40138626098627,
                            28.244028091430717
                        ],
                        [
                            -16.401527404785156,
                            28.244028091430717
                        ],
                        [
                            -16.401527404785156,
                            28.243806838989258
                        ],
                        [
                            -16.401805877685547,
                            28.24374961853033
                        ],
                        [
                            -16.401805877685547,
                            28.24347114562994
                        ],
                        [
                            -16.402082443237305,
                            28.24347114562994
                        ],
                        [
                            -16.402082443237305,
                            28.24292945861822
                        ],
                        [
                            -16.402082443237305,
                            28.24014091491705
                        ],
                        [
                            -16.402360916137695,
                            28.24014091491705
                        ],
                        [
                            -16.402360916137695,
                            28.239860534668082
                        ],
                        [
                            -16.402639389038086,
                            28.239860534668082
                        ],
                        [
                            -16.402639389038086,
                            28.239583969116268
                        ],
                        [
                            -16.40374946594227,
                            28.239583969116268
                        ],
                        [
                            -16.40374946594227,
                            28.239305496215874
                        ],
                        [
                            -16.404027938842717,
                            28.239305496215874
                        ],
                        [
                            -16.404027938842717,
                            28.23902893066412
                        ],
                        [
                            -16.404306411743104,
                            28.23902893066412
                        ],
                        [
                            -16.404306411743104,
                            28.23875045776373
                        ],
                        [
                            -16.404581069946232,
                            28.23875045776373
                        ],
                        [
                            -16.404581069946232,
                            28.238471984863335
                        ],
                        [
                            -16.40486335754389,
                            28.238471984863335
                        ],
                        [
                            -16.40486335754389,
                            28.237918853759762
                        ],
                        [
                            -16.40513801574707,
                            28.237918853759762
                        ],
                        [
                            -16.40513801574707,
                            28.237636566162166
                        ],
                        [
                            -16.40541648864746,
                            28.237636566162166
                        ],
                        [
                            -16.40541648864746,
                            28.237083435058594
                        ],
                        [
                            -16.405693054199162,
                            28.237083435058594
                        ],
                        [
                            -16.405693054199162,
                            28.23680686950678
                        ],
                        [
                            -16.405973434448242,
                            28.23680686950678
                        ],
                        [
                            -16.405973434448242,
                            28.236249923706055
                        ],
                        [
                            -16.406251907348633,
                            28.236249923706055
                        ],
                        [
                            -16.406251907348633,
                            28.23597145080566
                        ],
                        [
                            -16.406528472900334,
                            28.23597145080566
                        ],
                        [
                            -16.406528472900334,
                            28.235414505004883
                        ],
                        [
                            -16.406803131103516,
                            28.235414505004883
                        ],
                        [
                            -16.406803131103516,
                            28.23513984680187
                        ],
                        [
                            -16.407081604003906,
                            28.235137939453065
                        ],
                        [
                            -16.407081604003906,
                            28.2350368499757
                        ],
                        [
                            -16.407081604003906,
                            28.2343044281007
                        ],
                        [
                            -16.407363891601562,
                            28.2343044281007
                        ],
                        [
                            -16.407363891601562,
                            28.233194351196342
                        ],
                        [
                            -16.407638549804688,
                            28.233194351196342
                        ],
                        [
                            -16.407638549804688,
                            28.232082366943416
                        ],
                        [
                            -16.407917022705078,
                            28.232082366943416
                        ],
                        [
                            -16.407917022705078,
                            28.231689453125114
                        ],
                        [
                            -16.408990859985295,
                            28.23202514648449
                        ],
                        [
                            -16.418855667114258,
                            28.234815597534237
                        ],
                        [
                            -16.43037223815918,
                            28.243289947509766
                        ],
                        [
                            -16.448310852050724,
                            28.249301910400504
                        ],
                        [
                            -16.457887649536076,
                            28.256324768066406
                        ],
                        [
                            -16.464105606079045,
                            28.266380310058707
                        ],
                        [
                            -16.505407333373967,
                            28.28295707702631
                        ],
                        [
                            -16.513845443725586,
                            28.298276901245117
                        ],
                        [
                            -16.500736236572266,
                            28.307622909545895
                        ],
                        [
                            -16.49992370605463,
                            28.312873840332088
                        ],
                        [
                            -16.486745834350586,
                            28.327560424804744
                        ],
                        [
                            -16.48571014404291,
                            28.33262252807623
                        ],
                        [
                            -16.454076766967717,
                            28.33304786682129
                        ],
                        [
                            -16.437534332275334,
                            28.328931808471623
                        ],
                        [
                            -16.409254074096623,
                            28.33025550842291
                        ],
                        [
                            -16.38293266296381,
                            28.32360458374023
                        ],
                        [
                            -16.366798400878793,
                            28.335670471191406
                        ],
                        [
                            -16.36458206176752,
                            28.33587646484375
                        ]
                    ]
                ]
            }
        }, h3Resolution);
        contornos[municipios[d].recordid] = geojson2h3.h3SetToFeature(
            listhexagons[d]
        );
        console.log('end');
    } else {
        // este no va
        d = 0;
        listhexagons[0].push(geojson2h3.featureToH3Set(municipios[0], h3Resolution));
        contornos[municipios[d].recordid] = geojson2h3.h3SetToFeature(
            listhexagons[d],
            {
                colorscale: municipios[d].colorscale,
                municipio: municipios[d].municipio,
                provincia: municipios[d].provincia,
                communidad_autonoma: municipios[d].communidad_autonoma,
                pais: municipios[d].pais,
                geo_point_2d: municipios[d].geo_point_2d,
                dist: municipios[d].dist
            }
        );
        d = 1;
        listhexagons[1].push(geojson2h3.featureToH3Set(municipios[1], h3Resolution));
        contornos[municipios[d].recordid] = geojson2h3.h3SetToFeature(
            listhexagons[d],
            {
                colorscale: municipios[d].colorscale,
                municipio: municipios[d].municipio,
                provincia: municipios[d].provincia,
                communidad_autonoma: municipios[d].communidad_autonoma,
                pais: municipios[d].pais,
                geo_point_2d: municipios[d].geo_point_2d,
                dist: municipios[d].dist
            }
        );
    }

    /* for (let d = start; d < end; d++) {
        console.log('antes: '+d);
        console.log(listhexagons[d]);
        console.log({
            colorscale: municipios[d].colorscale,
            municipio: municipios[d].municipio,
            provincia: municipios[d].provincia,
            communidad_autonoma: municipios[d].communidad_autonoma,
            pais: municipios[d].pais,
            geo_point_2d: municipios[d].geo_point_2d,
            dist: municipios[d].dist
        });
    
        contornos[municipios[d].recordid] = geojson2h3.h3SetToFeature(
            listhexagons[d],
            {
                colorscale: municipios[d].colorscale,
                municipio: municipios[d].municipio,
                provincia: municipios[d].provincia,
                communidad_autonoma: municipios[d].communidad_autonoma,
                pais: municipios[d].pais,
                geo_point_2d: municipios[d].geo_point_2d,
                dist: municipios[d].dist
            }
        );  
        console.log('despues: '+d);      
    }
 */
    /* for (let d = 0; d < nhits; d++) {
         // Reduce hexagon list to a map with random values
         hexagons.push(listhexagons[d].reduce((res, hexagon) => ({ ...res, [hexagon]: getRandomIntInHex() }), {}));
     }*/
    // if (hexagons[d] == undefined) { ... }    

    /* for (let d = start; d < end; d++) {
        areas[municipios[d].recordid] = geojson2h3.h3SetToFeatureCollection(
            Object.keys(hexagons[d]),
            hex => ({ value: hexagons[d][hex], colorscale: municipios[d].colorscale })
        );
     }*/

    // console.log(hexagons);
    addinfo();
    for (let d = start; d < end; d++) {
        //renderContorno(municipios[d].recordid);
        //renderArea(municipios[d].recordid);        
    }
}

function addinfo() {
    info = L.control();
    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
        this._side1 = document.getElementById("sidebar1");
        this._side2 = document.getElementById("sidebar2");
        this._side3 = document.getElementById("sidebar3");
        this.update();
        return this._div;
    };

    // method that we will use to update the control based on feature properties passed
    info.update = function (props) {
        this._div.innerHTML = '<h4>Information</h4>' + (props ?
            props.value + ' people<br>4 city associations<br>1 national association'
            : 'Hover over map');
        this._side3.innerHTML = '<h4>Information</h4>' + (props ?
            props.value + ' people<br>4 city associations<br>1 national association'
            : 'Hover over map');
    };
    info.addTo(map);
}

function getColor(d, colorscale) {
    return d > Math.ceil(maxpersonsinhex * 2 / 3) ? config.colorScale[colorscale][2] :
        d > Math.ceil(maxpersonsinhex * 1 / 3) ? config.colorScale[colorscale][1] :
            config.colorScale[colorscale][0];
}
//---------------------------------------------------------------------------------------------------------
function entraMunicipio(e) {
    console.log(e.layer.feature.properties.colorscale);
    // contornos[id].map.setStyle({
    //     color: config.colorScale[contornos[id].properties.colorscale]
    // });
}
function saleMunicipio(e) {
    // contornos[id].map.resetStyle();
}

function stylecontour(feature) {
    // we can use feature.properties.colorscale
    return {
        stroke: true,
        fill: false,
        weight: 3,
        opacity: 1,
        color: '#636363'
    };
}
function renderContorno(id) {
    console.log('renderContorno');
    contornos[id].map = L.geoJson(contornos[id], { style: stylecontour }).addTo(map);
    console.log(contornos[id]);
}
function stylefill(feature) {
    //getColor(feature.properties.value, feature.properties.colorscale),
    return {
        fill: true,
        fillColor: getColor(feature.properties.value, feature.properties.colorscale),
        stroke: false,
        fillOpacity: 0.7
    };
}
function renderArea(id) {
    console.log('renderArea');
    areas[id].map = L.geoJson(areas[id], { style: stylefill }).on({
        mouseover: entraMunicipio,
        mouseout: saleMunicipio,
        // click: zoomToFeature
    }).addTo(map);
    console.log(areas[id]);
}

/*                  _           _
 *      /\/\   __ _(_)_ __     /_\  _ __ ___  __ _ ___
 *     /    \ / _` | | '_ \   //_\\| '__/ _ \/ _` / __|
 *    / /\/\ \ (_| | | | | | /  _  \ | |  __/ (_| \__ \
 *    \/    \/\__,_|_|_| |_| \_/ \_/_|  \___|\__,_|___/
 */
/* function incrementOpacity() {
    barcelona.setStyle({
        fillOpacity: 1
    });
}
function resetOpacity() {
    barcelona.resetStyle();
}

// function stylefill(feature) {
//     return {
//         fill: true,
//         fillColor: getColor(feature.properties.value, feature.properties.ngroup),
//         stroke: false,
//         fillOpacity: 0.2
//     };
// }

function renderHexes(map, hexagons, ngroup) {

    // Transform the current hexagon map into a GeoJSON object
    const geojson = geojson2h3.h3SetToFeatureCollection(
        Object.keys(hexagons),
        hex => ({ value: hexagons[hex], ngroup: ngroup })
    );

    console.log('geojson');
    console.log(geojson);

    if (barcelona == '') {
        barcelona = L.geoJson(geojson, { style: stylefill, onEachFeature: onEachFeature }).on({
            mouseover: incrementOpacity,
            mouseout: resetOpacity,
            // click: zoomToFeature
        }).addTo(map);
    } else {
        L.geoJson(geojson, { style: stylefill }).addTo(map);
    }
} */

/*                  _           ___            _
 *      /\/\   __ _(_)_ __     / __\___  _ __ | |_ ___  _ __ _ __   ___  ___
 *     /    \ / _` | | '_ \   / /  / _ \| '_ \| __/ _ \| '__| '_ \ / _ \/ __|
 *    / /\/\ \ (_| | | | | | / /__| (_) | | | | || (_) | |  | | | | (_) \__ \
 *    \/    \/\__,_|_|_| |_| \____/\___/|_| |_|\__\___/|_|  |_| |_|\___/|___/
 */

/* function stylecontour(feature) {
    return {
        stroke: true,
        fill: false,
        weight: 3,
        opacity: 1,
        color: '#636363'
        //color: getColor(maxpersonsinhex, feature.properties.ngroup)
    };
}
function renderAreas(map, hexagons, ngroup) {

    // console.log()

    // Transform the current hexagon map into a GeoJSON object
    const geojson = geojson2h3.h3SetToFeature(
        Object.keys(hexagons)
    );
    geojson.properties.ngroup = ngroup;

    // console.log(geojson);

    L.geoJson(geojson, { style: stylecontour }).addTo(map);
}
*/
/* http://patorjk.com/software/taag/#p=display&c=c&f=Ogre&t=Global%20variables%0A */